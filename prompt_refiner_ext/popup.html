<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<style>
  :root {
    --bg: #0b0b12; --bg2: #111119; --bg3: #191924; --bg4: #21212f;
    --border: #282840; --border-a: #3f3f60;
    --text: #e2e2ee; --text2: #8585a0; --dim: #4e4e68;
    --accent: #6366f1; --accent2: #818cf8; --accent-bg: rgba(99,102,241,0.12);
    --green: #34d399; --green-bg: rgba(52,211,153,0.10);
    --orange: #f59e0b; --orange-bg: rgba(245,158,11,0.10);
    --red: #ef4444; --red-bg: rgba(239,68,68,0.08);
    --cyan: #22d3ee; --cyan-bg: rgba(34,211,238,0.10);
    --r: 6px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    width: 460px; max-height: 600px; overflow-y: auto;
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text); font-size: 12px;
  }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .hdr {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    background: var(--bg2); position: sticky; top: 0; z-index: 20;
  }
  .hdr h1 { font-size: 13px; font-weight: 700; color: var(--accent2); }
  .hdr-right { display: flex; align-items: center; gap: 6px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--red); }
  .dot.on { background: var(--green); }
  select.sm { background: transparent; border: none; color: var(--text2); font-size: 10px; outline: none; cursor: pointer; }

  .nav {
    display: flex; border-bottom: 1px solid var(--border);
    background: var(--bg2); position: sticky; top: 33px; z-index: 19;
  }
  .nav-tab {
    flex: 1; padding: 7px 0; text-align: center;
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.8px; color: var(--dim); cursor: pointer;
    border-bottom: 2px solid transparent; transition: all 0.15s;
  }
  .nav-tab:hover { color: var(--text2); }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .page { display: none; }
  .page.active { display: block; }

  .sec { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .sec-label {
    font-size: 9px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1px; color: var(--dim); margin-bottom: 5px;
  }

  .grab { display: flex; gap: 4px; }
  .grab-btn {
    flex: 1; padding: 5px; background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--r); color: var(--text2); font-size: 10px; font-weight: 600;
    cursor: pointer; text-align: center; transition: all 0.12s;
  }
  .grab-btn:hover { border-color: var(--accent); color: var(--text); }
  .grab-btn.flash { border-color: var(--green); color: var(--green); }

  textarea {
    width: 100%; padding: 7px 9px; background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--r); color: var(--text); font-size: 12px; line-height: 1.5;
    resize: vertical; outline: none; font-family: inherit; transition: border-color 0.12s;
  }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--dim); }

  .chips { display: flex; flex-wrap: wrap; gap: 3px; }
  .chip {
    padding: 3px 8px; font-size: 10px; font-weight: 600;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: 16px; cursor: pointer; transition: all 0.1s;
  }
  .chip:hover { border-color: var(--border-a); }
  .chip.active { border-color: var(--accent); background: var(--accent-bg); color: var(--accent2); }

  .tgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }
  .tgl {
    display: flex; align-items: center; gap: 4px;
    padding: 3px 5px; cursor: pointer; border-radius: 3px; transition: background 0.1s;
  }
  .tgl:hover { background: rgba(255,255,255,0.02); }
  .tgl-box {
    width: 13px; height: 13px; border-radius: 3px; flex-shrink: 0;
    border: 1.5px solid var(--border); font-size: 8px;
    display: flex; align-items: center; justify-content: center; transition: all 0.1s;
  }
  .tgl.on .tgl-box { border-color: var(--accent); background: var(--accent); color: #fff; }
  .tgl-name { font-size: 10px; }

  select.full {
    width: 100%; padding: 5px 8px; background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--r); color: var(--text); font-size: 11px; outline: none; cursor: pointer;
  }

  .irow { display: flex; align-items: center; gap: 8px; }
  .irow label { font-size: 10px; color: var(--text2); white-space: nowrap; }
  input[type="range"] {
    flex: 1; -webkit-appearance: none; height: 3px;
    background: var(--bg4); border-radius: 2px; outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 11px; height: 11px;
    border-radius: 50%; background: var(--accent); cursor: pointer;
  }
  .val { font-size: 10px; color: var(--accent); font-weight: 600; min-width: 24px; text-align: right; }

  .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  .preset {
    padding: 6px 8px; background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--r); cursor: pointer; transition: all 0.12s;
  }
  .preset:hover { border-color: var(--accent); }
  .preset.active { border-color: var(--accent); background: var(--accent-bg); }
  .preset-name { font-size: 11px; font-weight: 700; }
  .preset-desc { font-size: 9px; color: var(--dim); margin-top: 1px; }

  .pipe-card {
    padding: 8px 10px; margin-bottom: 4px; background: var(--bg3);
    border: 1px solid var(--border); border-radius: var(--r);
    cursor: pointer; transition: all 0.12s;
  }
  .pipe-card:hover { border-color: var(--border-a); }
  .pipe-card.active { border-color: var(--cyan); background: var(--cyan-bg); }
  .pipe-name { font-size: 11px; font-weight: 700; }
  .pipe-desc { font-size: 9px; color: var(--dim); margin-top: 1px; }
  .pipe-agents { display: flex; gap: 3px; margin-top: 4px; flex-wrap: wrap; }
  .pipe-agent { font-size: 9px; padding: 1px 6px; background: var(--bg4); border-radius: 8px; color: var(--text2); font-weight: 600; }
  .pipe-arrow { color: var(--dim); font-size: 9px; }

  .actions { display: flex; gap: 5px; padding: 8px 12px; }
  .btn {
    flex: 1; padding: 8px; border: none; border-radius: var(--r);
    font-size: 11px; font-weight: 700; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 4px;
    transition: all 0.12s;
  }
  .btn-go { background: var(--accent); color: #fff; }
  .btn-go:hover { background: var(--accent2); }
  .btn-go:disabled { opacity: 0.4; cursor: default; }
  .btn-alt { background: var(--bg3); color: var(--text2); border: 1px solid var(--border); }
  .btn-alt:hover { border-color: var(--border-a); color: var(--text); }
  .btn-alt:disabled { opacity: 0.4; cursor: default; }
  .btn-cyan { background: var(--cyan-bg); color: var(--cyan); border: 1px solid rgba(34,211,238,0.25); }
  .btn-cyan:hover { border-color: var(--cyan); }
  .btn-cyan:disabled { opacity: 0.4; cursor: default; }

  #outputSection { display: none; }
  .out-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 12px; background: var(--bg2);
    border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
  }
  .out-tabs { display: flex; gap: 0; }
  .out-tab {
    padding: 4px 10px; font-size: 9px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--dim); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.1s;
  }
  .out-tab:hover { color: var(--text2); }
  .out-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .out-btns { display: flex; gap: 3px; }
  .out-btn {
    padding: 2px 7px; font-size: 9px; font-weight: 700;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: 3px; color: var(--text2); cursor: pointer; transition: all 0.1s;
  }
  .out-btn:hover { border-color: var(--accent); color: var(--accent); }
  .out-btn.ok { border-color: var(--green); color: var(--green); }

  .out-text {
    padding: 10px 12px; font-size: 12px; line-height: 1.6;
    white-space: pre-wrap; word-break: break-word;
    max-height: 220px; overflow-y: auto;
  }
  .out-text.sm { font-size: 10px; color: var(--text2); font-family: 'Consolas', monospace; }

  .agent-step {
    margin: 6px 12px; padding: 8px 10px;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--r); border-left: 3px solid var(--accent);
  }
  .agent-step:nth-child(2) { border-left-color: var(--green); }
  .agent-step:nth-child(3) { border-left-color: var(--orange); }
  .agent-step:nth-child(4) { border-left-color: var(--cyan); }
  .step-role { font-size: 10px; font-weight: 700; color: var(--accent2); margin-bottom: 3px; }
  .step-text { font-size: 11px; line-height: 1.5; color: var(--text); max-height: 120px; overflow-y: auto; white-space: pre-wrap; }
  .step-toggle { font-size: 9px; color: var(--dim); cursor: pointer; margin-top: 3px; }
  .step-toggle:hover { color: var(--text2); }

  .mrow { display: flex; gap: 4px; padding: 6px 12px; border-top: 1px solid rgba(255,255,255,0.03); }
  .mc { flex:1; background: var(--bg3); border-radius: 4px; padding: 5px 7px; text-align: center; }
  .mc-l { font-size: 8px; font-weight: 700; text-transform: uppercase; color: var(--dim); letter-spacing: 0.5px; }
  .mc-v { font-size: 14px; font-weight: 700; margin-top: 1px; }
  .mc-v.g { color: var(--green); }
  .mc-v.o { color: var(--orange); }

  .hist-item {
    padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.03);
    cursor: pointer; transition: background 0.1s;
  }
  .hist-item:hover { background: rgba(255,255,255,0.02); }
  .hist-meta { font-size: 9px; color: var(--dim); margin-bottom: 2px; display: flex; gap: 6px; }
  .hist-meta .tag { padding: 0px 5px; background: var(--bg4); border-radius: 8px; font-size: 8px; font-weight: 700; text-transform: uppercase; }
  .hist-orig { font-size: 11px; color: var(--text2); max-height: 36px; overflow: hidden; }
  .hist-empty { padding: 20px 12px; text-align: center; color: var(--dim); font-size: 11px; }

  .err {
    margin: 6px 12px; padding: 6px 8px; background: var(--red-bg);
    border: 1px solid rgba(239,68,68,0.2); border-radius: var(--r);
    color: #fca5a5; font-size: 11px; display: none;
  }
  .spin { display:inline-block; width:10px; height:10px; border:1.5px solid transparent; border-top-color:currentColor; border-radius:50%; animation:sp .5s linear infinite; }
  @keyframes sp { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<div class="hdr">
  <h1>PromptRefiner</h1>
  <div class="hdr-right">
    <div id="dot" class="dot"></div>
    <select class="sm" id="modelSelect"><option value="">--</option></select>
  </div>
</div>

<div class="nav">
  <div class="nav-tab active" data-page="refine">Refine</div>
  <div class="nav-tab" data-page="agentic">Agentic</div>
  <div class="nav-tab" data-page="history">History</div>
</div>

<!-- REFINE PAGE -->
<div class="page active" id="page-refine">
  <div class="sec">
    <div class="grab">
      <button class="grab-btn" data-grab="sel" data-target="promptInput">Selection</button>
      <button class="grab-btn" data-grab="ta" data-target="promptInput">Textarea</button>
      <button class="grab-btn" data-grab="clip" data-target="promptInput">Clipboard</button>
    </div>
    <textarea id="promptInput" rows="4" placeholder="Your raw prompt..." style="margin-top:5px;"></textarea>
  </div>

  <div class="sec">
    <div class="sec-label">Quick Presets</div>
    <div class="preset-grid" id="presetGrid"></div>
  </div>

  <div class="sec">
    <div class="sec-label">Mode</div>
    <div class="chips" id="modeChips"></div>
  </div>

  <div class="sec">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
      <div>
        <div class="sec-label">Persona</div>
        <select class="full" id="personaSelect"></select>
      </div>
      <div>
        <div class="sec-label">Temperature</div>
        <div class="irow">
          <input type="range" id="tempSlider" min="0" max="1.5" step="0.1" value="0.7">
          <span class="val" id="tempVal">0.7</span>
        </div>
      </div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-label">Modifiers</div>
    <div class="tgrid" id="toggleGrid"></div>
  </div>

  <div class="sec">
    <div class="sec-label">Custom Instructions</div>
    <textarea id="customInput" rows="2" placeholder="Extra context..."></textarea>
  </div>

  <div class="err" id="errBox"></div>

  <div class="actions">
    <button class="btn btn-go" id="refineBtn">Refine</button>
    <button class="btn btn-alt" id="chainBtn">Double</button>
  </div>

  <div id="outputSection">
    <div class="out-bar">
      <div class="out-tabs">
        <div class="out-tab active" data-out="refined">Refined</div>
        <div class="out-tab" data-out="changelog">Changes</div>
        <div class="out-tab" data-out="system">System</div>
      </div>
      <div class="out-btns">
        <button class="out-btn" id="copyBtn">Copy</button>
        <button class="out-btn" id="replBtn">Replace</button>
      </div>
    </div>
    <div class="out-text" id="outRefined"></div>
    <div class="out-text sm" id="outChangelog" style="display:none"></div>
    <div class="out-text sm" id="outSystem" style="display:none"></div>
    <div class="mrow" id="metricsRow"></div>
  </div>
</div>

<!-- AGENTIC PAGE -->
<div class="page" id="page-agentic">
  <div class="sec">
    <div class="grab">
      <button class="grab-btn" data-grab="sel" data-target="agInput">Selection</button>
      <button class="grab-btn" data-grab="ta" data-target="agInput">Textarea</button>
      <button class="grab-btn" data-grab="clip" data-target="agInput">Clipboard</button>
    </div>
    <textarea id="agInput" rows="4" placeholder="Prompt for agentic pipeline..." style="margin-top:5px;"></textarea>
  </div>

  <div class="sec">
    <div class="sec-label">Pipeline</div>
    <div id="pipelineList"></div>
  </div>

  <div class="err" id="agErrBox"></div>

  <div class="actions">
    <button class="btn btn-cyan" id="agBtn">Run Pipeline</button>
  </div>

  <div id="agOutput" style="display:none;">
    <div class="out-bar">
      <div style="font-size:10px; font-weight:700; color:var(--cyan);">AGENT STEPS</div>
      <div class="out-btns">
        <button class="out-btn" id="agCopy">Copy Final</button>
        <button class="out-btn" id="agRepl">Replace</button>
      </div>
    </div>
    <div id="agSteps"></div>
    <div class="out-bar" style="border-top:1px solid var(--border);">
      <div style="font-size:9px; font-weight:700; color:var(--dim); text-transform:uppercase; letter-spacing:1px;">Final Result</div>
    </div>
    <div class="out-text" id="agFinal" style="border-left: 3px solid var(--green); margin:0 12px 8px; padding:8px; background:var(--green-bg); border-radius:var(--r);"></div>
  </div>
</div>

<!-- HISTORY PAGE -->
<div class="page" id="page-history">
  <div id="histList"></div>
</div>

<script src="popup.js"></script>
</body>
</html>
